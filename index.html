<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartAttend Pro - Custom Schedule & Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
        --bg-main: #f8f9fa; 
        --bg-card: rgba(255, 255, 255, 0.9);
        --bg-header: rgba(255, 255, 255, 0.5); 
        --bg-modal: #ffffff;
        --bg-summary-card: #f8fafc;
        --text-primary: #495057; 
        --text-secondary: #adb5bd;
        --text-header: #343a40; 
        --text-bold: #212529;
        --border-color: rgba(0, 0, 0, 0.05);
        --fancy-gradient-start: #4f46e5; 
        --fancy-gradient-end: #7c3aed;
    }
    .dark {
        --bg-main: #1e293b; 
        --bg-card: rgba(100, 116, 139, 0.5);
        --bg-header: rgba(30, 41, 59, 0.5); 
        --bg-modal: #334155;
        --bg-summary-card: #1e293b;
        --text-primary: #cbd5e1; 
        --text-secondary: #94a3b8;
        --text-header: #e2e8f0; 
        --text-bold: #f1f5f9;
        --border-color: rgba(148, 163, 184, 0.2);
        --fancy-gradient-start: #6366f1; 
        --fancy-gradient-end: #8b5cf6;
    }
    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-main);
        color: var(--text-primary);
        overscroll-behavior-x: none;
    }
    .font-subject {
        font-family: 'Poppins', sans-serif;
    }
    .main-bg { background-image: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%); }
    .dark .main-bg { background-image: linear-gradient(120deg, #374151 0%, #111827 100%); }

    .fancy-button {
        background-image: linear-gradient(to right, var(--fancy-gradient-start), var(--fancy-gradient-end));
        transition: all 0.3s ease; box-shadow: 0 4px 15px 0 rgba(124, 58, 237, 0.3);
    }
    .fancy-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px 0 rgba(124, 58, 237, 0.4);
    }
    .fancy-button:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
    }
    .attendance-card, .modal-content, #schedule-customization-page .bg-white {
        background-color: var(--bg-card); backdrop-filter: blur(10px);
        border: 1px solid var(--border-color);
    }
    .dark .attendance-card, .dark .modal-content, .dark #schedule-customization-page .bg-white {
        background-color: #1e293b;
        border-color: rgba(148, 163, 184, 0.3);
    }
    .modal-content { background-color: var(--bg-modal); }
    .status-present { background-color: #dcfce7 !important; }
    .status-absent { background-color: #fee2e2 !important; }
    .status-cancelled { background-color: #e9ecef !important; text-decoration: line-through; }
   
    .status-present .class-info { color: #15803d; }
    .status-absent .class-info { color: #b91c1c; }
    .status-cancelled .class-info { color: #4b5563; }

    .dark .status-present, .dark .status-absent, .dark .status-cancelled {
        background-color: #1a202c !important;
    }

    .dark .status-present .class-info,
    .dark .status-absent .class-info,
    .dark .status-cancelled .class-info {
        color: #a0aec0;
    }
    .subject-summary-card {
        background-color: var(--bg-summary-card);
        border-color: var(--border-color);
    }
   
    .modal-overlay, .sidebar-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0, 0, 0, 0.6); display: flex; z-index: 50;
        opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay { align-items: center; justify-content: center; }
    .modal-overlay.visible, .sidebar-overlay.visible { opacity: 1; visibility: visible; }
    .modal-content {
        padding: 2rem; border-radius: 0.75rem;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        transform: scale(0.95); transition: transform 0.3s;
    }
    .modal-overlay.visible .modal-content { transform: scale(1); }
    #sidebar-menu {
        position: fixed; top: 0; left: 0; bottom: 0;
        width: 280px; background-color: var(--bg-modal);
        transform: translateX(-100%); transition: transform 0.3s ease-in-out;
        z-index: 60; box-shadow: 0 0 20px rgba(0,0,0,0.2);
    }
    #sidebar-menu.open { transform: translateX(0); }
    /* Toast elements are now globally positioned outside the main pages */
    #toast-notification, #reminder-toast {
        position: fixed; bottom: 20px; left: 50%;
        transform: translate(-50%, 200%); transition: transform 0.5s ease-in-out; z-index: 100;
    }
    #toast-notification.show, #reminder-toast.show { transform: translate(-50%, 0); }
   
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #4f46e5; }
    input:checked + .slider:before { transform: translateX(22px); }

    .reload-icon { transition: transform 0.5s ease-in-out; }
    .reload-icon:hover { transform: rotate(360deg); }

    .text-bold { color: var(--text-bold); }
    .text-secondary { color: var(--text-secondary); }

    /* Styles for Swipe-to-Delete */
    .class-card-wrapper {
        position: relative;
        overflow: hidden;
        border-radius: 0.5rem; /* Match card radius */
    }
    .swipe-content {
        position: relative;
        z-index: 10;
        touch-action: pan-y; /* Allow vertical scroll */
        transition: transform 0.3s ease-out;
    }
    .delete-action {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 90px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #ef4444;
        color: white;
        font-weight: 600;
        z-index: 5;
        cursor: pointer;
    }
    .dropdown-menu {
        position: absolute; right: 0; top: 100%; min-width: 150px; z-index: 20;
    }
    .editable-input {
        width: 40px; text-align: center; background: transparent; border: 1px solid #ccc; border-radius: 4px;
        padding: 1px 4px; margin: 0 4px;
    }
    .dark .editable-input {
        border-color: #555; background-color: #334155; color: #f1f5f9;
    }

    /* Loading Screen Styles - FIX: Ensure full mobile screen visibility and centering */
    #loading-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        /* Using vh and vw to ensure compatibility with mobile safe areas */
        width: 100vw;
        height: 100vh;
        min-height: -webkit-fill-available; /* For iOS Safari */
        background: linear-gradient(120deg, #4f46e5 0%, #7c3aed 100%);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 1000;
        transition: opacity 0.5s ease-out;
        opacity: 1;
        visibility: visible;
        color: white;
        font-family: 'Poppins', sans-serif;
        text-align: center;
        /* Ensures the content is well-centered and doesn't push off-screen */
        padding: 4vh 5vw; /* Add some padding for safety */
        box-sizing: border-box; 
    }
    #loading-overlay.hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
    }
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }
    #loading-text {
        animation: pulse 1.5s infinite;
        font-size: 1.5rem;
        margin-top: 20px;
        font-weight: 600;
    }

    /* Custom styles for the day selector tabs */
    .day-tab {
        @apply px-4 py-2 text-sm font-semibold rounded-lg transition duration-200;
        @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
    }
    .day-tab.active {
        background-image: linear-gradient(to right, var(--fancy-gradient-start), var(--fancy-gradient-end));
        @apply text-white shadow-md;
    }
    .dark .day-tab {
        @apply bg-slate-700 text-gray-300 hover:bg-slate-600;
    }
  </style>
</head>
<body class="antialiased">

  <!-- ====================================================================== -->
  <!-- 0. LOADING SCREEN (Fixed for Mobile View) -->
  <!-- ====================================================================== -->
  <div id="loading-overlay" class="hidden">
    <div class="text-center">
        <!-- FIX: Changed text-6xl to text-4xl (default) and sm:text-6xl for better fit in portrait mode -->
        <div class="text-4xl sm:text-6xl font-bold">SmartAttend Pro</div>
        <div id="loading-text">Designed and Developed by Waheed Mujtaba</div>
    </div>
  </div>


  <!-- ====================================================================== -->
  <!-- 1. LOGIN PAGE -->
  <!-- ====================================================================== -->
  <div id="login-page" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 space-y-6">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">SmartAttend Pro</h1>
            <p class="text-gray-500 mt-2">Please sign in to continue</p>
        </div>
        <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
        <div class="space-y-4">
            <input type="text" id="username" placeholder="Username" class="w-full px-4 py-3 rounded-lg bg-gray-100 border-transparent focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
            <div class="space-y-2">
                <input type="password" id="password" placeholder="Password (10-12 chars/numbers)" class="w-full px-4 py-3 rounded-lg bg-gray-100 border-transparent focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                <div class="flex items-center">
                    <input id="show-password" type="checkbox" onclick="togglePasswordVisibility()" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="show-password" class="ml-2 block text-sm text-gray-700">Show Password</label>
                </div>
            </div>
        </div>
        <button id="login-button" class="w-full text-white px-6 py-3 rounded-lg fancy-button font-semibold">Login</button>
       
        <div class="mt-6 p-4 bg-gray-50 rounded-lg text-sm text-gray-600 border border-gray-200">
            <p class="font-semibold text-gray-700 mb-2">Login Requirements:</p>
            <ul class="list-disc list-inside space-y-1">
                <li>**Username** cannot be empty.</li>
                <li>**Password** must be between 10 and 12 characters (letters/numbers).</li>
            </ul>
        </div>
        <div id="credit-line" class="text-center text-sm text-gray-500 pt-4 border-t border-gray-200">
            Designed & Developed by <strong class="font-semibold text-gray-600">Waheed Mujtaba</strong>
        </div>
    </div>
  </div>

  <!-- ====================================================================== -->
  <!-- 2. CUSTOM SCHEDULE SETUP PAGE -->
  <!-- ====================================================================== -->
  <div id="schedule-customization-page" class="hidden main-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-2xl p-6 md:p-10 space-y-6">
        <h1 class="text-3xl font-bold text-center text-text-bold">Customize Your Schedule</h1>
        <p class="text-center text-text-secondary">Define your weekly timetable. You can edit this later in Settings.</p>

        <!-- FIX: Replaced select dropdown with responsive tab selector -->
        <div id="day-selector-container" class="mb-6 overflow-x-auto">
            <div id="day-selector-tabs" class="flex justify-start sm:justify-center space-x-2 p-2">
                <!-- Day tabs generated by JavaScript -->
            </div>
        </div>

        <div id="schedule-editor-container" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2">
            <!-- Schedule editor content goes here -->
        </div>
        
        <!-- Responsive button group for schedule saving -->
        <div class="flex flex-col md:flex-row justify-center items-center mt-8 space-y-4 md:space-y-0 md:space-x-4">
             <button onclick="addScheduleEntry()" class="fancy-button text-white w-full md:w-auto px-4 py-2 rounded-full font-semibold text-base md:text-sm">
                <i class="fas fa-plus mr-2"></i>Add Class
            </button>
            <button onclick="saveCustomSchedule()" class="fancy-button text-white w-full md:w-auto px-8 py-3 rounded-lg font-semibold text-lg">
                Save Schedule
            </button>
             <button onclick="navigateTo('app-page', 'main')" class="bg-gray-400 hover:bg-gray-500 text-white w-full md:w-auto px-8 py-3 rounded-lg font-semibold text-lg">
                Close Editor
            </button>
        </div>
    </div>
  </div>


  <!-- ====================================================================== -->
  <!-- 3. MAIN APP PAGE -->
  <!-- ====================================================================== -->
  <div id="app-page" class="hidden main-bg min-h-screen">
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleMenu()"></div>
    <div id="sidebar-menu" class="p-6 flex flex-col h-full">
        <h2 class="text-2xl font-bold text-indigo-600 mb-8">Menu</h2>
        <nav class="flex flex-col space-y-4">
            <a href="#" onclick="toggleMenu(); navigateTo('app-page', 'main');" class="text-lg hover:text-indigo-600 transition flex items-center">
                <i class="fas fa-home w-6 mr-3"></i>Home
            </a>
            <a href="#" onclick="showProfileModal()" class="text-lg hover:text-indigo-600 transition flex items-center">
                <i class="fas fa-user-circle w-6 mr-3"></i>Profile Details
            </a>
            <a href="#" onclick="showSummaryModal()" class="text-lg hover:text-indigo-600 transition flex items-center">
                <i class="fas fa-chart-pie w-6 mr-3"></i>Attendance Summary
            </a>
            <a href="#" onclick="showProgressTrackerModal()" class="text-lg hover:text-indigo-600 transition flex items-center">
                <i class="fas fa-chart-bar w-6 mr-3"></i>Progress Tracker
            </a>
            <a href="#" onclick="showAnalysisModal()" class="text-lg hover:text-indigo-600 transition flex items-center">
                <i class="fas fa-chart-line w-6 mr-3"></i>Analysis
            </a>
            <a href="#" onclick="showReportModal()" class="text-lg hover:text-indigo-600 transition flex items-center">
                <i class="fas fa-table w-6 mr-3"></i>Attendance Sheet <span class="text-xs text-red-500 ml-2">(Report)</span>
            </a>
            <a href="#" onclick="showScheduleModal()" class="text-lg hover:text-indigo-600 transition flex items-center">
                <i class="fas fa-calendar-alt w-6 mr-3"></i>View Schedule
            </a>
            <a href="#" onclick="showImportExportModal()" class="text-lg hover:text-indigo-600 transition flex items-center">
                <i class="fas fa-exchange-alt w-6 mr-3"></i>Export/Import Data
            </a>
            <a href="#" onclick="showFeedbackModal()" class="text-lg hover:text-indigo-600 transition flex items-center">
                <i class="fas fa-comment-dots w-6 mr-3"></i>Feedback
            </a>
            <a href="#" onclick="showAboutModal()" class="text-lg hover:text-indigo-600 transition flex items-center">
                <i class="fas fa-info-circle w-6 mr-3"></i>About Us
            </a>
            <a href="#" onclick="showSettingsModal()" class="text-lg hover:text-indigo-600 transition flex items-center">
                <i class="fas fa-cog w-6 mr-3"></i>Settings
            </a>
        </nav>
        <div class="mt-auto pt-4 border-t border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <span class="text-lg">Dark Mode</span>
                <label class="switch">
                    <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
                    <span class="slider round"></span>
                </label>
            </div>
            <div>
                <a href="#" onclick="handleLogout()" class="text-lg hover:text-red-600 transition flex items-center">
                    <i class="fas fa-sign-out-alt w-6 mr-3"></i>Logout
                </a>
            </div>
        </div>
    </div>

    <header class="bg-header backdrop-blur-lg shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
            <button onclick="toggleMenu()" class="p-2 rounded-md text-text-header hover:text-indigo-600 hover:bg-white/50">
                <i class="fas fa-bars w-6 h-6"></i>
            </button>
            <div id="header-attendance" class="text-lg font-bold text-text-header hidden sm:block"></div>
            <div class="flex items-center space-x-4">
                <button onclick="window.location.reload()" class="p-2 rounded-md text-text-header hover:text-indigo-600 hover:bg-white/50" title="Reload Page">
                    <i class="fas fa-sync-alt w-5 h-5 reload-icon"></i>
                </button>
                <input type="date" id="date-picker" class="bg-white/50 border border-gray-300 rounded-lg px-3 py-1.5 text-sm text-gray-700 dark:text-gray-200 dark:bg-slate-700/50">
                <div id="username-display" class="text-lg font-bold text-text-header text-right hidden sm:block"></div>
                <img id="header-profile-picture" src="https://placehold.co/40x40/e0e0e0/757575?text=P" class="w-10 h-10 rounded-full object-cover border-2 border-indigo-200">
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 min-h-[calc(100vh-140px)]">
        <div id="attendance-alert" class="p-4 mb-6 rounded-lg shadow-md" role="alert"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="attendance-card rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                         <h2 id="timetable-title" class="text-2xl font-bold text-text-bold"></h2>
                        <button id="add-class-btn" onclick="openAddClassModal()" title="Add Extra Class" class="fancy-button text-white rounded-full w-10 h-10 flex items-center justify-center text-xl font-bold">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="daily-schedule" class="space-y-4"></div>
                </div>
                <div class="flex flex-wrap justify-center items-center gap-4">
                    <button onclick="saveData()" class="text-white px-8 py-3 rounded-lg fancy-button font-semibold text-lg">Save Attendance</button>
                    <div class="relative inline-block text-left" x-data="{ open: false }" @click.away="open = false">
                        <button onclick="toggleDropdown(event)" class="inline-flex justify-center w-full sm:w-auto rounded-lg border border-gray-300 shadow-sm px-4 py-3 bg-white text-lg font-semibold text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:bg-slate-700 dark:text-gray-200 dark:border-slate-600" id="more-actions-btn" aria-expanded="true" aria-haspopup="true">
                            More Actions <i class="fas fa-caret-down ml-2"></i>
                        </button>
                        <div id="more-actions-dropdown" class="dropdown-menu origin-top-right right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none dark:bg-slate-700 hidden">
                            <div class="py-1" role="none">
                                <a href="#" onclick="clearTodaysAttendance(); toggleDropdown(event);" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-slate-600">
                                    <i class="fas fa-times-circle mr-2 text-red-500"></i>Clear Attendance
                                </a>
                                <a href="#" onclick="markDayAsHoliday(); toggleDropdown(event);" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-slate-600" id="holiday-dropdown-item">
                                    <i class="fas fa-calendar-check mr-2 text-blue-500"></i>Mark as Holiday
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="attendance-card rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-center mb-6 text-text-bold">Overall Summary</h2>
                <div class="chart-container" style="position: relative; height:280px; width:100%; max-w: 350px; margin: auto;">
                    <canvas id="attendanceChart"></canvas>
                </div>
                <div id="attendance-stats" class="text-center mt-4 space-y-1"></div>
            </div>
        </div>
    </main>
    <footer class="text-center text-sm text-gray-500 py-3 border-t border-gray-200 dark:border-gray-700 bg-header backdrop-blur-md">
        Designed & Developed by <strong class="font-semibold text-gray-600 dark:text-gray-300">Waheed Mujtaba</strong>
    </footer>
  </div>
 
  <!-- ====================================================================== -->
  <!-- 4. MODALS -->
  <!-- Profile Modal (Updated for editing) -->
  <div id="profile-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-lg">
        <h3 class="text-2xl font-bold mb-6 text-center text-text-bold">Profile Details</h3>
        <div class="flex flex-col items-center text-center">
            <img id="profile-picture" src="https://placehold.co/128x128/e0e0e0/757575?text=Upload" class="w-32 h-32 rounded-full mb-4 object-cover border-4 border-indigo-200">
            <input type="file" id="profile-pic-upload" class="hidden" accept="image/*">
            <button onclick="document.getElementById('profile-pic-upload').click()" class="text-sm text-indigo-600 hover:underline mb-6">Change Picture</button>
            
            <div id="profile-details-content" class="text-left space-y-3 w-full">
                <div class="flex flex-col sm:flex-row sm:items-center">
                    <strong class="font-semibold text-text-secondary sm:w-24">Name:</strong> 
                    <input type="text" id="edit-name" class="w-full sm:w-auto flex-grow p-2 border rounded-md dark:bg-slate-600 mt-1 sm:mt-0">
                </div>
                 <div class="flex flex-col sm:flex-row sm:items-center">
                    <strong class="font-semibold text-text-secondary sm:w-24">Password:</strong> 
                    <span id="display-password" class="text-bold p-2"></span>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center">
                    <strong class="font-semibold text-text-secondary sm:w-24">College:</strong> 
                    <input type="text" id="edit-college" class="w-full sm:w-auto flex-grow p-2 border rounded-md dark:bg-slate-600 mt-1 sm:mt-0">
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center">
                    <strong class="font-semibold text-text-secondary sm:w-24">Branch:</strong> 
                    <input type="text" id="edit-branch" class="w-full sm:w-auto flex-grow p-2 border rounded-md dark:bg-slate-600 mt-1 sm:mt-0">
                </div>
            </div>
        </div>
        <div class="text-center mt-8 space-x-4">
            <button onclick="saveProfileDetails()" class="text-white px-6 py-2 rounded-lg fancy-button">Save Changes</button>
            <button onclick="closeModal('profile-modal')" class="text-gray-700 bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition">Close</button>
        </div>
    </div>
  </div>


  <!-- Schedule Modal (Now displays custom schedule) -->
  <div id="schedule-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-4xl">
        <h3 class="text-2xl font-bold mb-6 text-center text-text-bold">Your Customized Weekly Schedule</h3>
        <div id="schedule-content" class="max-h-[60vh] overflow-y-auto pr-2"></div>
        <div class="text-center mt-6">
            <button onclick="closeModal('schedule-modal')" class="text-white px-6 py-2 rounded-lg fancy-button">Close</button>
        </div>
    </div>
  </div>
  
  <!-- Settings Modal (New Edit Schedule option) -->
  <div id="settings-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-lg">
        <h3 class="text-2xl font-bold mb-6 text-center text-text-bold">Settings</h3>
        <div class="space-y-4">
            <div class="flex justify-between items-center p-4 border rounded-lg">
                <span class="text-lg font-medium">Edit Weekly Schedule</span>
                <button onclick="navigateTo('schedule-customization-page', 'edit'); closeModal('settings-modal');" class="text-white px-4 py-2 rounded-lg fancy-button text-sm">Edit</button>
            </div>
            <div class="flex justify-between items-center p-4 border rounded-lg">
                <span class="text-lg font-medium">Set Reminders</span>
                <label class="switch">
                    <input type="checkbox" id="settings-reminder-toggle" onchange="toggleReminders(event)">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="flex justify-between items-center p-4 border rounded-lg">
                <span class="text-lg font-medium">Check Version</span>
                <button onclick="showVersionModal(true)" class="text-white px-4 py-2 rounded-lg fancy-button text-sm">Check</button>
            </div>
            <div class="flex justify-between items-center p-4 border rounded-lg bg-red-50 dark:bg-red-900/20">
                <span class="text-lg font-medium text-red-600">Erase All Data</span>
                <button onclick="confirmEraseAllData(true)" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition text-sm">Erase</button>
            </div>
        </div>
        <div class="text-center mt-8">
            <button onclick="closeModal('settings-modal')" class="text-gray-700 bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition">Close</button>
        </div>
    </div>
  </div>
 
  <!-- Report Modal (Renamed to Attendance Sheet) -->
  <div id="report-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-4xl">
        <h3 class="text-2xl font-bold mb-6 text-center text-text-bold">Attendance Sheet <span class="text-base text-secondary">(Editable)</span></h3>
        <div id="report-content" class="max-h-[60vh] overflow-y-auto pr-2"></div>
        <div class="text-center mt-6">
            <button onclick="saveReportEdits()" class="text-white px-6 py-2 rounded-lg bg-green-500 hover:bg-green-600 font-semibold transition mr-4">Save Edits</button>
            <button onclick="downloadReport()" class="text-white px-6 py-2 rounded-lg fancy-button" id="download-sheet-btn">Download Sheet</button>
            <button onclick="closeModal('report-modal')" class="text-gray-700 bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition">Close</button>
        </div>
    </div>
  </div>
  
  <!-- Other Modals (Summary, Progress, Erase, Analysis, Add Class, Feedback, About, Download, Version) -->
  <div id="summary-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-2xl">
        <h3 class="text-2xl font-bold mb-6 text-center text-text-bold">Subject-wise Summary</h3>
        <div id="subject-summary-content" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
        <div class="text-center mt-6">
            <button onclick="closeModal('summary-modal')" class="text-white px-6 py-2 rounded-lg fancy-button">Close</button>
        </div>
    </div>
  </div>
 
  <div id="progress-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-2xl">
        <h3 class="text-2xl font-bold mb-6 text-center text-text-bold">Progress Tracker</h3>
        <div id="progress-tracker-content" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
        <div class="text-center mt-6">
            <button onclick="closeModal('progress-modal')" class="text-white px-6 py-2 rounded-lg fancy-button">Close</button>
        </div>
    </div>
  </div>

  <div id="erase-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-md text-center">
        <h3 class="text-2xl font-bold mb-4 text-red-600">Are you sure?</h3>
        <p class="text-text-secondary mb-6">This will permanently delete all your saved attendance records. This action cannot be undone.</p>
        <div class="flex justify-center space-x-4">
            <button onclick="closeModal('erase-modal')" class="text-gray-700 bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition">Cancel</button>
            <button onclick="eraseAllData()" class="text-white bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold transition">Yes, Erase Everything</button>
        </div>
    </div>
  </div>

  <div id="analysis-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-3xl">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-text-bold">Attendance Trend Analysis</h3>
            <div>
                <span class="text-sm font-medium mr-2">Sort by:</span>
                <select id="trend-sort" class="rounded-lg p-2 bg-gray-200 dark:bg-slate-600 text-text-primary">
                    <option value="day">Day</option>
                    <option value="week">Week</option>
                    <option value="month">Month</option>
                </select>
            </div>
        </div>
        <div style="height: 400px;">
            <canvas id="trendChart"></canvas>
        </div>
        <div class="text-center mt-6">
            <button onclick="closeModal('analysis-modal')" class="text-white px-6 py-2 rounded-lg fancy-button">Close</button>
        </div>
    </div>
  </div>
 
  <div id="add-class-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-md">
        <h3 class="text-2xl font-bold mb-6 text-center text-text-bold">Add Extra Class (Today)</h3>
        <div class="space-y-4">
            <p class="text-sm text-secondary">Only subjects from your saved schedule are available.</p>
            <div>
                <label for="extra-class-subject" class="block text-sm font-medium text-text-secondary">Subject</label>
                <select id="extra-class-subject" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white dark:bg-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
            </div>
            <div>
                <label for="extra-class-time" class="block text-sm font-medium text-text-secondary">Time (e.g., 14:00-15:00)</label>
                <input type="text" id="extra-class-time" placeholder="HH:MM-HH:MM" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white dark:bg-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
        </div>
        <div class="flex justify-center space-x-4 mt-6">
            <button onclick="closeModal('add-class-modal')" class="text-gray-700 bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition">Cancel</button>
            <button onclick="handleAddClass()" class="text-white px-6 py-2 rounded-lg fancy-button">Add Class</button>
        </div>
    </div>
  </div>
 
  <div id="feedback-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-lg">
        <h3 class="text-2xl font-bold mb-6 text-center text-text-bold">Send Feedback</h3>
        <p class="text-text-secondary mb-4">Have a suggestion or found a bug? Let me know!</p>
        <textarea id="feedback-text" class="w-full h-32 p-3 border border-gray-300 rounded-md bg-white dark:bg-slate-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Type your feedback here..."></textarea>
        <div class="flex justify-center space-x-4 mt-6">
            <button onclick="closeModal('feedback-modal')" class="text-gray-700 bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition">Cancel</button>
            <button onclick="sendFeedback()" class="text-white px-6 py-2 rounded-lg fancy-button">Send Feedback</button>
        </div>
    </div>
  </div>

  <div id="about-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-lg">
        <h3 class="text-2xl font-bold mb-6 text-center text-text-bold">About SmartAttend Pro</h3>
        <div class="space-y-4 text-text-primary">
            <p><strong>SmartAttend Pro</strong> is designed and developed by <strong>Waheed Mujtaba</strong> to help students effortlessly track their attendance.</p>
            <p><strong>Key Features:</strong></p>
            <ul class="list-disc list-inside space-y-2">
                <li>Daily schedule view with easy attendance marking.</li>
                <li>Overall and subject-wise attendance summary.</li>
                <li>Progress tracker to monitor your attendance percentage.</li>
                <li>Trend analysis to visualize your attendance over time.</li>
                <li>Customizable with dark mode and profile picture upload.</li>
                <li>Set reminders for your classes.</li>
                <li>Export and import your attendance data.</li>
            </ul>
            <p class="text-center mt-6">
                Connect with the developer: 
                <a href="https://www.linkedin.com/in/waheed-mujtaba/" target="_blank" class="text-indigo-600 hover:underline flex items-center justify-center">
                    <i class="fab fa-linkedin mr-2"></i>LinkedIn/waheed-mujtaba
                </a>
                <a href="https://github.com/Waheed-6907" target="_blank" class="text-indigo-600 hover:underline flex items-center justify-center">
                    <i class="fab fa-github mr-2"></i>GitHub/Waheed-6907
                </a>
            </p>
        </div>
        <div class="text-center mt-6">
            <button onclick="closeModal('about-modal')" class="text-white px-6 py-2 rounded-lg fancy-button">Close</button>
        </div>
    </div>
  </div>

  <div id="import-export-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-lg">
        <h3 class="text-2xl font-bold mb-6 text-center text-text-bold">Export / Import Data</h3>
        <div class="space-y-6">
            <div class="p-4 border rounded-lg">
                <h4 class="font-semibold text-lg mb-2">Export Data</h4>
                <p class="text-text-secondary mb-4">Download all your attendance data as a mobile-friendly text file. You can use this file to transfer your data to another device.</p>
                <button onclick="exportData()" class="w-full text-white px-6 py-2 rounded-lg fancy-button">Export My Data</button>
            </div>
            <div class="p-4 border rounded-lg">
                <h4 class="font-semibold text-lg mb-2">Import Data</h4>
                <p class="text-text-secondary mb-4">Select a previously exported data file to restore your attendance records. <strong class="text-red-500">This will overwrite any existing data.</strong></p>
                <input type="file" id="import-file-input" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100" accept=".txt,text/plain,application/json">
            </div>
        </div>
        <div class="text-center mt-8">
            <button onclick="closeModal('import-export-modal')" class="text-gray-700 bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition">Close</button>
        </div>
    </div>
  </div>

  <div id="download-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-sm text-center">
        <h3 id="download-title" class="text-2xl font-bold mb-4 text-text-bold">File Ready</h3>
        <p id="download-message" class="text-text-secondary mb-6">Your file is ready to be downloaded.</p>
        <div class="flex flex-col space-y-4">
            <a id="download-link" href="#" download="" class="w-full text-white px-6 py-3 rounded-lg fancy-button font-semibold text-lg">Download Now</a>
            <button onclick="closeDownloadModal()" class="text-gray-700 bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-semibold transition">Cancel</button>
        </div>
    </div>
  </div>

  <div id="version-modal" class="modal-overlay">
    <div class="modal-content w-full max-w-sm text-center">
        <h3 class="text-2xl font-bold mb-4 text-text-bold">App Version</h3>
        <p class="text-4xl font-bold text-indigo-600 mb-2">4.0</p>
        <p class="text-text-secondary">You are on the latest version.</p>
        <div class="text-center mt-6">
            <button onclick="closeModal('version-modal')" class="text-white px-6 py-2 rounded-lg fancy-button">OK</button>
        </div>
    </div>
  </div>

  <!-- FIX: Moved Toast Elements Outside of the hidden #app-page for global access -->
  <div id="toast-notification" class="text-white text-sm py-2 px-4 rounded-full shadow-lg"></div>
  <div id="reminder-toast" class="text-white text-sm py-3 px-5 rounded-full shadow-2xl bg-indigo-500"></div>

  <script>
    // --- GLOBAL DATA & CONSTANTS ---
    let attendanceData = {};
    let tempAttendanceData = {};
    let extraClasses = {};
    let holidays = [];
    let dailyRemovedClasses = {};
    let attendanceChart, trendChart;
    let selectedDate = new Date();
    let reminderTimeouts = [];
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    let audioCtx;
    let currentDownloadUrl = null;
    let customSchedule = null; 
    const ALL_DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    
    let subjectStatsEdits = {}; // New global variable for subject summary edits
    let currentScheduleDay = 'Monday'; // Track the currently selected day for the editor
    
    // --- CONFIGURATION CONSTANTS ---
    const FEEDBACK_EMAIL = "gulamwaheedmujtaba@gmail.com";


    // --- UTILITY FUNCTIONS ---
    function playSound(type = 'click') {
        if (!audioCtx) return;
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        if (type === 'click') {
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
        } else if (type === 'save') {
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
        }
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.1);
    }
    
    function navigateTo(pageId, context) {
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('app-page').classList.add('hidden');
        document.getElementById('schedule-customization-page').classList.add('hidden');

        if (pageId === 'schedule-customization-page') {
            loadCustomSchedule(); 
            initScheduleCustomization();
            document.getElementById('schedule-customization-page').classList.remove('hidden');
        } else if (pageId === 'app-page') {
            // Check if schedule is set when navigating to app-page (e.g., via Close Editor)
            const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
            loadInitialData(userData.name);
            if (!customSchedule) {
                 // Force back to customization if schedule is missing
                 showToast('Please set your schedule first.', 'bg-red-500');
                 navigateTo('schedule-customization-page');
                 return;
            }
            // Run loading screen before showing the app
            showLoadingOverlay(() => {
                initializeApp(userData.name);
                document.getElementById('app-page').classList.remove('hidden');
            });
        } else {
            document.getElementById(pageId).classList.remove('hidden');
        }
    }
    
    // FIX: Added showLoadingOverlay function (Point 2)
    function showLoadingOverlay(callback) {
        const overlay = document.getElementById('loading-overlay');
        overlay.classList.remove('hidden');

        const startTime = Date.now();
        const minDuration = 1000; // Minimum duration for effect
        const maxDuration = 3000; // Safety maximum duration

        let called = false;
        const delayedCallback = () => {
             if (called) return;
             called = true;
             
             // Ensure the overlay stays visible for a minimum time
             const timeElapsed = Date.now() - startTime;
             const delay = Math.max(0, minDuration - timeElapsed);

             setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    if (callback) callback();
                }, 500); // 500ms fade transition
             }, delay);
        };
        
        // Safety timeout to ensure it doesn't hang
        setTimeout(delayedCallback, maxDuration);
        // Call callback immediately for the rest of the logic
        // This ensures the main app loads data while the splash screen is visible
        setTimeout(() => {
            if (!called) delayedCallback();
        }, 100); 
    }


    function toggleDropdown(event) {
        playSound('click');
        const dropdown = document.getElementById('more-actions-dropdown');
        const isHidden = dropdown.classList.contains('hidden');
        // Close the dropdown if it's currently open
        if (!isHidden) {
            dropdown.classList.add('hidden');
            return;
        }

        document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.add('hidden')); // Close others
        
        const dateString = selectedDate.toISOString().split('T')[0];
        const isHoliday = holidays.includes(dateString);
        document.getElementById('holiday-dropdown-item').innerHTML = `<i class="fas ${isHoliday ? 'fa-calendar-times' : 'fa-calendar-check'} mr-2 text-blue-500"></i>${isHoliday ? 'Unmark Holiday' : 'Mark as Holiday'}`;
        dropdown.classList.remove('hidden');
        
        // Prevent event propagation so click away functionality works
        if (event && event.stopPropagation) {
            event.stopPropagation();
        }
    }

    function openModal(modalId) { 
        playSound('click');
        document.getElementById(modalId).classList.add('visible'); 
    }
    function closeModal(modalId) { 
        playSound('click');
        document.getElementById(modalId).classList.remove('visible'); 
    }
    function toggleMenu() { 
        playSound('click');
        document.getElementById('sidebar-menu').classList.toggle('open'); 
        document.getElementById('sidebar-overlay').classList.toggle('visible'); 
    }
    
    function showToast(message = 'Attendance saved successfully!', bgColor = 'bg-green-500', elementId = 'toast-notification', duration = 3000) {
        const toast = document.getElementById(elementId);
        if (!toast) {
            console.error(`Toast element with ID ${elementId} not found.`);
            return;
        }
        toast.innerHTML = message;
        toast.className = `text-white text-sm py-2 px-4 rounded-full shadow-lg ${bgColor} show`;
        setTimeout(() => { toast.classList.remove('show'); }, duration);
    }


    // --- AUTH AND INITIALIZATION ---

    function handleLogin() {
        playSound('save');
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const loginError = document.getElementById('login-error');
        
        if (!username || password.length < 10 || password.length > 12) {
            loginError.innerHTML = 'Invalid username or password. Password must be 10-12 characters/numbers.';
            loginError.classList.remove('hidden'); return;
        }
       
        loginError.classList.add('hidden');
        
        const existingUser = localStorage.getItem('smartAttendUser');
        let userData;

        if (existingUser) {
            userData = JSON.parse(existingUser);
            userData.name = username;
            userData.password = password;
        } else {
            userData = { name: username, password: password, college: '', branch: '' };
        }

        localStorage.setItem('smartAttendUser', JSON.stringify(userData));
        checkAuth();
    }
   
    function handleLogout() { localStorage.removeItem('smartAttendUser'); window.location.reload(); }
    function togglePasswordVisibility() { const p = document.getElementById('password'); p.type = p.type === 'password' ? 'text' : 'password'; }

    function loadInitialData(username) {
        const data = localStorage.getItem(`smartAttendData_${username}`);
        attendanceData = data ? JSON.parse(data) : {};
        const holidaysData = localStorage.getItem(`smartAttendHolidays_${username}`);
        holidays = holidaysData ? JSON.parse(holidaysData) : [];
        const extraData = localStorage.getItem(`smartAttendExtraClasses_${username}`);
        extraClasses = extraData ? JSON.parse(extraData) : {};
        const removedData = localStorage.getItem(`smartAttendRemovedClasses_${username}`);
        dailyRemovedClasses = removedData ? JSON.parse(removedData) : {};
        const scheduleData = localStorage.getItem(`smartAttendSchedule_${username}`);
        customSchedule = scheduleData ? JSON.parse(scheduleData) : null;
    }

    function checkAuth() {
        const savedTheme = localStorage.getItem('smartAttendTheme') || 'light';
        document.documentElement.className = savedTheme;
        const toggle = document.getElementById('dark-mode-toggle');
        if (toggle) toggle.checked = (savedTheme === 'dark');

        const user = localStorage.getItem('smartAttendUser');
        if (user) {
            const userData = JSON.parse(user);
            loadInitialData(userData.name);

            document.getElementById('login-page').classList.add('hidden');
            
            if (!customSchedule) {
                // Show loading overlay, then customize page
                showLoadingOverlay(() => {
                    document.getElementById('schedule-customization-page').classList.remove('hidden');
                    initScheduleCustomization();
                });
            } else {
                // Show loading overlay, then main app page
                showLoadingOverlay(() => {
                    document.getElementById('app-page').classList.remove('hidden');
                    initializeApp(userData.name);
                });
            }
        } else {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('app-page').classList.add('hidden');
            document.getElementById('schedule-customization-page').classList.add('hidden');
        }
    }

    // --- SCHEDULE CUSTOMIZATION LOGIC ---

    function selectScheduleDay(day) {
        playSound('click');
        currentScheduleDay = day;
        renderScheduleEditor();
    }

    function initScheduleCustomization() {
        const tabsContainer = document.getElementById('day-selector-tabs');
        tabsContainer.innerHTML = '';
        
        if (!customSchedule) {
            customSchedule = {};
            ALL_DAYS.forEach(day => customSchedule[day] = []);
        }

        // Determine default selected day (Today's day name, or Monday if array calculation fails)
        const today = new Date();
        const currentDayIndex = today.getDay();
        // Adjust array index (0=Mon, 6=Sun) based on JS date index (0=Sun, 6=Sat)
        let scheduleDayIndex = (currentDayIndex === 0) ? 6 : currentDayIndex - 1; 
        
        currentScheduleDay = ALL_DAYS[scheduleDayIndex] || ALL_DAYS[0];
        
        // Generate day buttons/tabs
        ALL_DAYS.forEach(day => {
            const button = document.createElement('button');
            button.className = `day-tab ${day === currentScheduleDay ? 'active' : ''}`;
            // Use short names for mobile compatibility
            const displayDay = day.substring(0, 3);
            button.textContent = displayDay;
            button.onclick = () => selectScheduleDay(day);
            tabsContainer.appendChild(button);
        });
        
        renderScheduleEditor();
    }

    function renderScheduleEditor() {
        const day = currentScheduleDay;
        const container = document.getElementById('schedule-editor-container');
        container.innerHTML = '';
        
        const schedule = customSchedule[day] || [];

        // Update active tab visual
        document.querySelectorAll('#day-selector-tabs .day-tab').forEach(btn => {
            if (btn.textContent.toLowerCase().startsWith(day.substring(0, 3).toLowerCase())) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        if (schedule.length === 0) {
            container.innerHTML = `<p class="text-center text-text-secondary py-4">No classes added for ${day}. Click 'Add Class' below.</p>`;
        } else {
            schedule.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center space-x-2 p-3 bg-gray-50 dark:bg-slate-700 rounded-lg shadow-sm';
                item.innerHTML = `
                    <input type="text" value="${entry.time}" data-index="${index}" data-field="time" placeholder="HH:MM-HH:MM" 
                           class="w-1/3 p-2 border rounded-md text-sm dark:bg-slate-600" onchange="updateScheduleEntry('${day}', this)">
                    <input type="text" value="${entry.subject}" data-index="${index}" data-field="subject" placeholder="Subject Name (e.g., IDS)" 
                           class="w-1/3 p-2 border rounded-md text-sm dark:bg-slate-600" onchange="updateScheduleEntry('${day}', this)">
                    <button onclick="removeScheduleEntry('${day}', ${index})" class="text-red-500 hover:text-red-700 p-2 rounded-full transition">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                container.appendChild(item);
            });
        }
    }

    function addScheduleEntry() {
        const day = currentScheduleDay;
        if (!customSchedule[day]) customSchedule[day] = [];
        
        customSchedule[day].push({ time: '', subject: '' });
        renderScheduleEditor();
    }

    function removeScheduleEntry(day, index) {
        playSound('click');
        customSchedule[day].splice(index, 1);
        renderScheduleEditor();
    }

    function updateScheduleEntry(day, inputElement) {
        const index = parseInt(inputElement.getAttribute('data-index'));
        const field = inputElement.getAttribute('data-field');
        const value = inputElement.value.trim();

        if (customSchedule[day] && customSchedule[day][index]) {
            customSchedule[day][index][field] = value;
        }
    }

    function saveCustomSchedule() {
        playSound('save');
        const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
        const scheduleToSave = {};
        let isValid = true;
        let totalClasses = 0;

        ALL_DAYS.forEach(day => {
            scheduleToSave[day] = customSchedule[day].filter(entry => entry.time && entry.subject);
            scheduleToSave[day].forEach(entry => {
                if (!/^\d{1,2}:\d{2}-\d{1,2}:\d{2}$/.test(entry.time)) {
                    isValid = false;
                }
                totalClasses++;
            });
        });

        if (!isValid) {
            showToast('Time format error! Use HH:MM-HH:MM (e.g., 9:00-10:00).', 'bg-red-500', 'toast-notification', 5000);
            return;
        }
        
        if (totalClasses === 0) {
            showToast('Please add at least one class to your schedule.', 'bg-red-500', 'toast-notification', 5000);
            return;
        }

        customSchedule = scheduleToSave;
        localStorage.setItem(`smartAttendSchedule_${userData.name}`, JSON.stringify(customSchedule));
        
        showToast('Schedule saved successfully!', 'bg-green-500');
        navigateTo('app-page');
    }

    function loadCustomSchedule() {
        const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
        const scheduleData = localStorage.getItem(`smartAttendSchedule_${userData.name}`);
        customSchedule = scheduleData ? JSON.parse(scheduleData) : {};
        
        ALL_DAYS.forEach(day => {
             if (!customSchedule[day]) customSchedule[day] = [];
        });
    }

    // --- HOMEPAGE AND ATTENDANCE LOGIC ---

    function getUniqueSubjects() {
        const subjects = new Set();
        if (customSchedule) {
            ALL_DAYS.forEach(day => {
                (customSchedule[day] || []).forEach(entry => {
                    if (entry.subject) subjects.add(entry.subject);
                });
            });
        }
        return Array.from(subjects).sort();
    }

    function openAddClassModal() {
        playSound('click');
        const select = document.getElementById('extra-class-subject');
        const subjects = getUniqueSubjects();
        
        if (subjects.length === 0) {
             showToast('Please define your schedule first to list subjects.', 'bg-orange-500');
             return;
        }

        select.innerHTML = subjects.map(s => `<option value="${s}">${s}</option>`).join('');
        document.getElementById('extra-class-time').value = '';
        openModal('add-class-modal');
    }

    function handleAddClass() {
        playSound('save');
        const subject = document.getElementById('extra-class-subject').value;
        const time = document.getElementById('extra-class-time').value.trim();
        
        if (!subject || !time) { 
            showToast('Please fill in both subject and time.', 'bg-red-500'); 
            return; 
        }
        if (!/^\d{1,2}:\d{2}-\d{1,2}:\d{2}$/.test(time)) {
            showToast('Time format error! Use HH:MM-HH:MM (e.g., 9:00-10:00).', 'bg-red-500');
            return;
        }
       
        const dateString = selectedDate.toISOString().split('T')[0];
        if (!extraClasses[dateString]) extraClasses[dateString] = [];
        extraClasses[dateString].push({ time, subject, type: 'extra' });
       
        const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
        localStorage.setItem(`smartAttendExtraClasses_${userData.name}`, JSON.stringify(extraClasses));

        closeModal('add-class-modal');
        renderDailySchedule();
        scheduleRemindersForToday();
        showToast('Extra class added for today', 'bg-blue-500');
    }

    function renderDailySchedule() {
        const scheduleContainer = document.getElementById('daily-schedule');
        const dropdownItem = document.getElementById('holiday-dropdown-item');
        
        const dateString = selectedDate.toISOString().split('T')[0];
        const isHoliday = holidays.includes(dateString);

        if (isHoliday) {
            scheduleContainer.innerHTML = `<p class="text-center text-secondary text-lg font-semibold py-8"><i class="fas fa-calendar-alt mr-2"></i>Today is a Holiday!</p>`;
            if(dropdownItem) dropdownItem.innerHTML = `<i class="fas fa-calendar-times mr-2 text-blue-500"></i>Unmark Holiday`;
            return;
        }
       
        if(dropdownItem) dropdownItem.innerHTML = `<i class="fas fa-calendar-check mr-2 text-blue-500"></i>Mark as Holiday`;
        scheduleContainer.innerHTML = '';
        const dayName = dayNames[selectedDate.getDay()];
        document.getElementById('timetable-title').textContent = `${dayName}'s Schedule`;

        const daySchedule = customSchedule[dayName] || [];
        const currentExtraClasses = extraClasses[dateString] || [];
        const todaysRemovedClasses = dailyRemovedClasses[dateString] || [];

        let allPeriods = [...daySchedule, ...currentExtraClasses];
        
        allPeriods = allPeriods.filter(period => {
            const classId = `${dateString}|${period.subject}|${period.time}`;
            return !todaysRemovedClasses.includes(classId);
        });

        if (allPeriods.length === 0) {
            scheduleContainer.innerHTML = `<p class="text-center text-secondary">No classes scheduled for today.</p>`; return;
        }

        allPeriods.forEach(period => {
            const classId = `${dateString}|${period.subject}|${period.time}`;
            let status = tempAttendanceData.hasOwnProperty(classId) ? tempAttendanceData[classId] : (attendanceData[classId] || 'none');
            const card = createClassCard(classId, period.subject, period.time, status);
            scheduleContainer.appendChild(card);
        });
    }

    function createClassCard(classId, subject, time, status) {
        const wrapper = document.createElement('div');
        wrapper.className = 'class-card-wrapper';

        const deleteAction = document.createElement('div');
        deleteAction.className = 'delete-action';
        deleteAction.textContent = 'Delete';
        deleteAction.onclick = () => deleteClassForToday(classId);
        
        const swipeContent = document.createElement('div');
        swipeContent.className = `swipe-content p-4 rounded-lg flex items-center justify-between transition border ${status === 'none' ? 'bg-slate-50 dark:bg-slate-800' : ''} status-${status}`;
        
        swipeContent.innerHTML = `
            <div class="class-info flex-grow mr-4">
                <p class="font-bold text-lg text-bold font-subject">${subject}</p>
                <p class="text-sm text-secondary">${time}</p>
            </div>
            <div class="flex space-x-2 flex-shrink-0">
                <button onclick="markTempAttendance('${classId}', 'present')" class="w-10 h-10 rounded-full font-semibold ${status === 'present' ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-200'} transition">P</button>
                <button onclick="markTempAttendance('${classId}', 'absent')" class="w-10 h-10 rounded-full font-semibold ${status === 'absent' ? 'bg-red-500 text-white' : 'bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-200'} transition">A</button>
                <button onclick="markTempAttendance('${classId}', 'cancelled')" class="w-10 h-10 rounded-full font-semibold ${status === 'cancelled' ? 'bg-slate-500 text-white' : 'bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-200'} transition">C</button>
            </div>`;
        
        wrapper.appendChild(deleteAction);
        wrapper.appendChild(swipeContent);

        // Swipe logic
        let startX = 0, currentX = 0, isDragging = false, isScrolling = false;
        const threshold = 50;
        const deleteWidth = 90;
        let currentlyOpenCard = null;

        const handleTouchStart = (e) => {
            if (currentlyOpenCard && currentlyOpenCard !== swipeContent) {
                currentlyOpenCard.style.transform = 'translateX(0px)';
            }
            startX = e.touches[0].clientX;
            currentX = startX;
            isDragging = true;
            isScrolling = false;
            swipeContent.style.transition = 'none';
        };

        const handleTouchMove = (e) => {
            if (!isDragging) return;
            currentX = e.touches[0].clientX;
            const deltaX = currentX - startX;

            if (Math.abs(deltaX) > 10 && !isScrolling) {
                if(Math.abs(e.touches[0].clientY - e.touches[0].target.getBoundingClientRect().top) > 20) {
                    isScrolling = true;
                    isDragging = false;
                    return;
                }
            }
            
            if (isScrolling) return;

            if (deltaX < 0 && deltaX > -deleteWidth - 20) {
                    swipeContent.style.transform = `translateX(${deltaX}px)`;
            }
        };

        const handleTouchEnd = () => {
            if (!isDragging || isScrolling) return;
            isDragging = false;
            swipeContent.style.transition = 'transform 0.3s ease-out';
            const deltaX = currentX - startX;
            if (deltaX < -threshold) {
                swipeContent.style.transform = `translateX(-${deleteWidth}px)`;
                currentlyOpenCard = swipeContent;
            } else {
                swipeContent.style.transform = 'translateX(0px)';
                if(currentlyOpenCard === swipeContent) currentlyOpenCard = null;
            }
        };

        swipeContent.addEventListener('touchstart', handleTouchStart, { passive: true });
        swipeContent.addEventListener('touchmove', handleTouchMove, { passive: true });
        swipeContent.addEventListener('touchend', handleTouchEnd);
        
        return wrapper;
    }
    
    function deleteClassForToday(classId) {
        playSound('click');
        const dateString = selectedDate.toISOString().split('T')[0];
        if (!dailyRemovedClasses[dateString]) {
            dailyRemovedClasses[dateString] = [];
        }
        dailyRemovedClasses[dateString].push(classId);
        
        const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
        localStorage.setItem(`smartAttendRemovedClasses_${userData.name}`, JSON.stringify(dailyRemovedClasses));
        
        delete tempAttendanceData[classId];
        delete attendanceData[classId];
        localStorage.setItem(`smartAttendData_${userData.name}`, JSON.stringify(attendanceData));

        renderDailySchedule();
        updateAllAnalytics();
        showToast('Class removed for today', 'bg-blue-500');
    }

    function markTempAttendance(classId, status) { 
        playSound('click');
        tempAttendanceData[classId] = (tempAttendanceData.hasOwnProperty(classId) && tempAttendanceData[classId] === status) ? undefined : status; 
        renderDailySchedule(); 
    }
    
    function saveData() {
        playSound('save');
        Object.keys(tempAttendanceData).forEach(classId => {
            if (tempAttendanceData[classId] === undefined) delete attendanceData[classId];
            else attendanceData[classId] = tempAttendanceData[classId];
        });
        tempAttendanceData = {};
        const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
        localStorage.setItem(`smartAttendData_${userData.name}`, JSON.stringify(attendanceData));
        updateAllAnalytics();
        renderDailySchedule();
        showToast();
    }
    
    function clearTodaysAttendance() {
        playSound('click');
        const dateString = selectedDate.toISOString().split('T')[0];
        tempAttendanceData = {};
        let cleared = false;
        Object.keys(attendanceData).forEach(classId => {
            if (classId.startsWith(dateString)) {
                delete attendanceData[classId];
                cleared = true;
            }
        });
        if (extraClasses[dateString]) {
            delete extraClasses[dateString];
            const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
            localStorage.setItem(`smartAttendExtraClasses_${userData.name}`, JSON.stringify(extraClasses));
        }
        
        renderDailySchedule();
        if (cleared) {
            const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
            localStorage.setItem(`smartAttendData_${userData.name}`, JSON.stringify(attendanceData));
            updateAllAnalytics();
            showToast("Today's attendance cleared", 'bg-blue-500');
        }
    }
    
    function markDayAsHoliday() {
        playSound('click');
        const dateString = selectedDate.toISOString().split('T')[0];
        const holidayIndex = holidays.indexOf(dateString);

        if (holidayIndex > -1) {
            holidays.splice(holidayIndex, 1);
            showToast('Day unmarked as holiday.', 'bg-blue-500');
        } else {
            holidays.push(dateString);
            showToast('Day marked as holiday.', 'bg-red-500');
        }

        const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
        localStorage.setItem(`smartAttendHolidays_${userData.name}`, JSON.stringify(holidays));
        
        const dropdown = document.getElementById('more-actions-dropdown');
        if (dropdown) dropdown.classList.add('hidden');
        
        renderDailySchedule();
        updateAllAnalytics();
    }


    // --- ANALYTICS AND UTILS ---

    function calculateOverallStats() {
        let present = 0, absent = 0, cancelled = 0;
        Object.keys(attendanceData).forEach(classId => {
            const date = classId.split('|')[0];
            if(holidays.includes(date)) return;

            const status = attendanceData[classId];
            if (status === 'present') present++; else if (status === 'absent') absent++; else if (status === 'cancelled') cancelled++;
        });
        const conducted = present + absent;
        const percentage = conducted > 0 ? ((present / conducted) * 100) : 100.0;
        
        let needed = 0;
        if (percentage < 75 && conducted > 0) {
            needed = Math.ceil((0.75 * conducted - present) / 0.25);
        }

        return { present, absent, cancelled, percentage: percentage, needed };
    }

    function getSubjectStats() {
        const subjectStats = {};
        const allSubjects = getUniqueSubjects();
        allSubjects.forEach(s => { 
            subjectStats[s] = { present: 0, absent: 0, cancelled: 0, total: 0, title: s }; 
        });

        for (const classId in attendanceData) {
            const date = classId.split('|')[0];
            if(holidays.includes(date)) continue;

            const subjectAbbr = classId.split('|')[1];
            if (subjectStats[subjectAbbr]) {
                const status = attendanceData[classId];
                if (subjectStats[subjectAbbr][status] !== undefined) {
                    subjectStats[subjectAbbr][status]++;
                }
                subjectStats[subjectAbbr].total++;
            }
        }
        return subjectStats;
    }
    
    function calculatePrediction(present, conducted, classesToAttend) {
        if (isNaN(present) || isNaN(conducted) || conducted === 0) return null;
        if (classesToAttend <= 0) return (present / conducted) * 100;
        
        const futurePresent = present + classesToAttend;
        const futureConducted = conducted + classesToAttend;
        return (futurePresent / futureConducted) * 100;
    }


    function updateHeaderAttendance({ percentage }) {
        const header = document.getElementById('header-attendance');
        if (header) header.innerHTML = `Overall: <span class="text-indigo-400">${percentage.toFixed(1)}%</span>`;
    }
   
    function updateSummaryCard(stats) {
        let { present, absent, cancelled, percentage, needed } = stats;
        
        if (!attendanceChart) {
            if(document.getElementById('attendanceChart')) initChart();
        }
        if (attendanceChart) {
            attendanceChart.data.datasets[0].data = [present, absent, cancelled];
            attendanceChart.update();
        }

        const statsDiv = document.getElementById('attendance-stats');
        if (statsDiv) statsDiv.innerHTML = `<p class="text-lg font-semibold text-bold">Overall: <span class="text-indigo-600">${percentage.toFixed(1)}%</span></p><p class="text-sm text-secondary"><span class="font-semibold text-green-600">${present}</span> P &bull; <span class="font-semibold text-red-600">${absent}</span> A &bull; <span class="font-semibold text-slate-500">${cancelled}</span> C</p>`;

        const alertBox = document.getElementById('attendance-alert');
        if (alertBox) {
            if (percentage >= 75) {
                alertBox.className = 'p-4 mb-6 rounded-lg shadow-md bg-green-100 dark:bg-green-900/20 border-l-4 border-green-500 text-green-700 dark:text-green-300';
                alertBox.innerHTML = `<p class="font-bold"><i class="fas fa-check-circle mr-2"></i>Great Job!</p><p>Your attendance is looking good. Keep up the great work!</p>`;
            } else if (percentage < 40) {
                alertBox.className = 'p-4 mb-6 rounded-lg shadow-md bg-red-100 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-300';
                alertBox.innerHTML = `<p class="font-bold"><i class="fas fa-exclamation-triangle mr-2"></i>Danger Zone!</p><p>Your attendance is critically low. You may be detained if this continues.</p>`;
            } else if (needed > 0) {
                alertBox.className = 'p-4 mb-6 rounded-lg shadow-md bg-yellow-100 dark:bg-yellow-900/20 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-300';
                alertBox.innerHTML = `<p class="font-bold"><i class="fas fa-exclamation-circle mr-2"></i>Low Attendance Alert!</p><p>You need to attend the next <strong>${needed}</strong> class(es) consecutively to recover.</p>`;
            } else {
                alertBox.className = 'hidden p-4 mb-6 rounded-lg shadow-md';
            }
        }
    }

    function updateAllAnalytics() {
        // Only run if on the app page
        if(document.getElementById('app-page').classList.contains('hidden')) return; 

        const stats = calculateOverallStats();
        updateHeaderAttendance(stats);
        updateSummaryCard(stats);
    }
    
    function showSummaryModal() {
        toggleMenu();
        const summaryContent = document.getElementById('subject-summary-content');
        summaryContent.innerHTML = '';
        const subjectStats = getSubjectStats();

        let hasData = false;
        for (const subject in subjectStats) {
            const stats = subjectStats[subject];
            const conductedClasses = stats.present + stats.absent;
            if (conductedClasses === 0) continue;
            hasData = true;
            
            const percentage = conductedClasses > 0 ? ((stats.present / conductedClasses) * 100) : 0;
            const prediction = calculatePrediction(stats.present, conductedClasses, 5);
            let predictionHTML = '';
            
            if (prediction !== null) {
                const predText = `If you attend the next 5 classes, your attendance will be <strong>${prediction.toFixed(1)}%</strong>.`;
                predictionHTML = `<p class="text-xs text-blue-500 dark:text-blue-400 mt-2"><i class="fas fa-level-up-alt mr-1"></i> ${predText}</p>`;
            }

            const subjectDiv = document.createElement('div');
            subjectDiv.className = 'subject-summary-card p-4 border rounded-lg';
            subjectDiv.innerHTML = `
                <div class="flex justify-between items-baseline">
                    <h4 class="font-bold text-lg text-bold font-subject">${stats.title}</h4>
                    <span class="text-2xl font-bold text-indigo-600">${percentage.toFixed(1)}%</span>
                </div>
                <p class="text-sm text-secondary mb-2">${stats.title}: ${stats.present} attended / ${conductedClasses} conducted</p>
                <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-indigo-500 h-2 rounded-full" style="width: ${percentage}%"></div></div>
                <div class="text-xs text-right text-secondary mt-1"><span>P: ${stats.present}</span> &bull; <span>A: ${stats.absent}</span> &bull; <span>C: ${stats.cancelled}</span></div>
                ${predictionHTML}
            `;
            summaryContent.appendChild(subjectDiv);
        }
        
        if (!hasData) {
            summaryContent.innerHTML = `<p class="text-center text-secondary text-lg font-semibold py-8">No attendance records found yet. Mark some attendance first.</p>`;
        }
        
        openModal('summary-modal');
    }

    function showProgressTrackerModal() {
        toggleMenu();
        const content = document.getElementById('progress-tracker-content');
        content.innerHTML = '';
        const subjectStats = getSubjectStats();

        let hasData = false;
        for (const subject in subjectStats) {
            const stats = subjectStats[subject];
            const conducted = stats.present + stats.absent;
            if (conducted === 0) continue;
            hasData = true;
            
            const percentage = ((stats.present / conducted) * 100);
            const color = percentage >= 75 ? 'bg-green-500' : percentage >= 50 ? 'bg-yellow-500' : 'bg-red-500';

            const subjectDiv = document.createElement('div');
            subjectDiv.className = 'subject-summary-card p-3 rounded-lg border';
            subjectDiv.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-bold font-subject">${stats.title}</span>
                    <span class="font-semibold text-sm ${percentage < 75 ? 'text-red-500' : 'text-green-500'}">${percentage.toFixed(1)}%</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-4">
                    <div class="${color} h-4 rounded-full text-center text-white text-xs font-bold flex items-center justify-center" style="width: ${percentage}%">${stats.present}/${conducted}</div>
                </div>`;
            content.appendChild(subjectDiv);
        }

        if (!hasData) {
            content.innerHTML = `<p class="text-center text-secondary text-lg font-semibold py-8">No conducted classes found to track progress. Mark some attendance first.</p>`;
        }
        
        openModal('progress-modal');
    }
    
    function showProfileModal() {
        toggleMenu();
        const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
        const profilePic = localStorage.getItem(`smartAttendProfilePic_${userData.name}`);
        if (profilePic) {
            document.getElementById('profile-picture').src = profilePic;
        }

        document.getElementById('edit-name').value = userData.name || '';
        document.getElementById('display-password').textContent = userData.password ? '*****' : 'Not set';
        document.getElementById('edit-college').value = userData.college || '';
        document.getElementById('edit-branch').value = userData.branch || '';

        openModal('profile-modal');
    }
    
    function saveProfileDetails() {
        playSound('save');
        let userData = JSON.parse(localStorage.getItem('smartAttendUser'));
        
        const newName = document.getElementById('edit-name').value.trim();
        const oldName = userData.name;
        
        userData.name = newName;
        userData.college = document.getElementById('edit-college').value.trim();
        userData.branch = document.getElementById('edit-branch').value.trim();
        
        localStorage.setItem('smartAttendUser', JSON.stringify(userData));

        if (newName !== oldName) {
            const keysToMigrate = ['smartAttendData', 'smartAttendHolidays', 'smartAttendExtraClasses', 'smartAttendRemovedClasses', 'smartAttendSchedule', 'smartAttendProfilePic'];
            keysToMigrate.forEach(key => {
                const oldKey = `${key}_${oldName}`;
                const newKey = `${key}_${newName}`;
                const data = localStorage.getItem(oldKey);
                if (data) {
                    localStorage.setItem(newKey, data);
                    localStorage.removeItem(oldKey);
                }
            });
            showToast('Profile saved. Reloading due to name change...', 'bg-orange-500');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            document.getElementById('username-display').innerHTML = `Welcome, ${userData.name}`;
            closeModal('profile-modal');
            showToast('Profile details updated!', 'bg-green-500');
        }
    }
    
    // FIX: Make Subject Summary editable (Point 1)
    function showReportModal() {
        toggleMenu();
        const reportContent = document.getElementById('report-content');
        const subjectStats = getSubjectStats();
        const overallStats = calculateOverallStats();
        
        // Reset edits cache
        subjectStatsEdits = {};
        
        let reportHTML = ``;

        // 1. Subject-wise Summary Table (Editable)
        reportHTML += `<h4 class="text-xl font-bold mb-4 text-text-bold">Subject Summary (Editable)</h4>`;
        reportHTML += `<table class="w-full text-left border-collapse mb-8">
            <thead>
                <tr class="bg-indigo-200 dark:bg-indigo-800 text-indigo-800 dark:text-indigo-200">
                    <th class="py-2 px-4 border-b rounded-tl-lg">Subject</th>
                    <th class="py-2 px-4 border-b">Attended</th>
                    <th class="py-2 px-4 border-b">Conducted</th>
                    <th class="py-2 px-4 border-b rounded-tr-lg">Percentage</th>
                </tr>
            </thead>
            <tbody>`;
        
        const subjectRows = [];
        for (const subject in subjectStats) {
            const stats = subjectStats[subject];
            const conducted = stats.present + stats.absent;
            // Only show subjects that are part of the current schedule
            if (getUniqueSubjects().includes(subject)) {
                 subjectStatsEdits[subject] = { present: stats.present, conducted: conducted }; // Initialize edit cache
                const percentage = conducted > 0 ? ((stats.present / conducted) * 100).toFixed(1) : (stats.present === 0 && conducted === 0 ? '0.0' : '0.0');
                
                reportHTML += `
                    <tr class="hover:bg-gray-50 dark:hover:bg-slate-800" data-subject="${subject}">
                        <td class="py-2 px-4 border-b text-sm font-medium">${stats.title}</td>
                        <td class="py-2 px-4 border-b text-sm text-green-600 font-semibold">
                            <input type="number" value="${stats.present}" min="0" data-field="present" onchange="tempUpdateSubjectStats('${subject}', this)" class="editable-input text-green-600 dark:text-green-400">
                        </td>
                        <td class="py-2 px-4 border-b text-sm">
                            <input type="number" value="${conducted}" min="0" data-field="conducted" onchange="tempUpdateSubjectStats('${subject}', this)" class="editable-input">
                        </td>
                        <td class="py-2 px-4 border-b text-sm font-bold percentage-cell">${percentage}%</td>
                    </tr>`;
            }
        }
        reportHTML += `</tbody>
            <tfoot>
                <tr class="font-bold bg-indigo-100 dark:bg-indigo-900/50">
                    <td class="py-2 px-4 border-t">Overall</td>
                    <td class="py-2 px-4 border-t text-green-600" id="report-overall-present">${overallStats.present}</td>
                    <td class="py-2 px-4 border-t" id="report-overall-conducted">${overallStats.present + overallStats.absent}</td>
                    <td class="py-2 px-4 border-t" id="report-overall-percentage">${overallStats.percentage.toFixed(1)}%</td>
                </tr>
            </tfoot>
        </table>`;


        // 2. Detailed Attendance Sheet Table (Editable)
        reportHTML += `<h4 class="text-xl font-bold mb-4 text-text-bold">Detailed Daily Attendance</h4>`;
        reportHTML += `<table class="w-full text-left border-collapse" id="attendance-sheet-table">
            <thead>
                <tr class="bg-indigo-500 text-white">
                    <th class="py-2 px-4 border-b rounded-tl-lg">Date</th>
                    <th class="py-2 px-4 border-b">Class</th>
                    <th class="py-2 px-4 border-b">Time</th>
                    <th class="py-2 px-4 border-b rounded-tr-lg">Status</th>
                </tr>
            </thead>
            <tbody>`;
       
        window.reportEdits = {}; // Reset daily edits cache

        const allRecords = Object.keys(attendanceData).map(classId => {
            const [date, subject, time] = classId.split('|');
            return { date, subject, time, status: attendanceData[classId], classId };
        }).sort((a, b) => new Date(a.date) - new Date(b.date));

        allRecords.forEach(record => {
            const statusColor = record.status === 'present' ? 'bg-green-100 text-green-700' : 
                                record.status === 'absent' ? 'bg-red-100 text-red-700' : 
                                'bg-gray-100 text-gray-700';

            const statusOptions = ['present', 'absent', 'cancelled'].map(s => 
                `<option value="${s}" ${record.status === s ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>`
            ).join('');

            reportHTML += `
                <tr data-classid="${record.classId}" class="hover:bg-gray-50 dark:hover:bg-slate-800">
                    <td class="py-2 px-4 border-b text-sm font-medium">${record.date}</td>
                    <td class="py-2 px-4 border-b text-sm">${record.subject}</td>
                    <td class="py-2 px-4 border-b text-sm">${record.time}</td>
                    <td class="py-2 px-4 border-b">
                        <select onchange="tempUpdateReport(this)" data-classid="${record.classId}" class="p-1 text-xs rounded-md border ${statusColor} dark:bg-slate-600 dark:text-gray-200">
                            ${statusOptions}
                        </select>
                    </td>
                </tr>`;
        });

        reportHTML += `</tbody></table>`;
       
        reportContent.innerHTML = reportHTML;
        openModal('report-modal');
    }

    // FIX: New function to handle subject summary edits (Point 1)
    function tempUpdateSubjectStats(subject, inputElement) {
        const field = inputElement.getAttribute('data-field');
        let value = parseInt(inputElement.value);
        if (isNaN(value) || value < 0) value = 0;
        
        inputElement.value = value;
        subjectStatsEdits[subject][field] = value;
        
        // Live update percentage and overall stats
        const { present, conducted } = subjectStatsEdits[subject];
        const newPercentage = conducted > 0 ? ((present / conducted) * 100).toFixed(1) : (present === 0 && conducted === 0 ? '0.0' : '0.0');
        
        const row = inputElement.closest('tr');
        if (row) {
             const percentageCell = row.querySelector('.percentage-cell');
             if(percentageCell) percentageCell.textContent = `${newPercentage}%`;
        }
        
        // Update overall footer
        let totalPresent = 0;
        let totalConducted = 0;
        Object.values(subjectStatsEdits).forEach(stats => {
             totalPresent += stats.present;
             totalConducted += stats.conducted;
        });
        
        const overallPercentage = totalConducted > 0 ? ((totalPresent / totalConducted) * 100).toFixed(1) : '0.0';
        document.getElementById('report-overall-present').textContent = totalPresent;
        document.getElementById('report-overall-conducted').textContent = totalConducted;
        document.getElementById('report-overall-percentage').textContent = `${overallPercentage}%`;
    }
    
    function tempUpdateReport(selectElement) {
        const classId = selectElement.getAttribute('data-classid');
        const newStatus = selectElement.value;
        selectElement.className = selectElement.className.replace(/bg-(green|red|gray)-100/g, '').replace(/text-(green|red|gray)-700/g, '');
        const statusColor = newStatus === 'present' ? 'bg-green-100 text-green-700' : 
                            newStatus === 'absent' ? 'bg-red-100 text-red-700' : 
                            'bg-gray-100 text-gray-700';
        selectElement.classList.add(...statusColor.split(' '));
        
        if (!window.reportEdits) window.reportEdits = {};
        window.reportEdits[classId] = newStatus;
    }
    
    // FIX: Reworked save logic to handle both sheet edits and subject summary edits (Point 1)
    function saveReportEdits() {
        if ((!window.reportEdits || Object.keys(window.reportEdits).length === 0) && Object.keys(subjectStatsEdits).length === 0) {
            showToast('No edits to save.', 'bg-gray-500');
            return;
        }

        const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
        
        // 1. Process Detailed Daily Attendance Edits
        if (window.reportEdits && Object.keys(window.reportEdits).length > 0) {
            Object.keys(window.reportEdits).forEach(classId => {
                attendanceData[classId] = window.reportEdits[classId];
            });
            window.reportEdits = {}; // Clear daily edits
        }

        // 2. Process Subject Summary Edits (Creates dummy records)
        const currentStats = getSubjectStats();
        let recordsAdded = 0;

        Object.keys(subjectStatsEdits).forEach(subject => {
            const current = currentStats[subject];
            const edited = subjectStatsEdits[subject];
            
            const deltaPresent = edited.present - (current ? current.present : 0);
            const deltaAbsent = edited.conducted - (current ? current.present + current.absent : 0) - deltaPresent;

            if (deltaPresent !== 0 || deltaAbsent !== 0) {
                
                if (edited.present >= 0 && edited.conducted >= edited.present) {

                    // Clear existing dummy records for this subject (1970-01-01)
                    Object.keys(attendanceData).forEach(classId => {
                        if (classId.startsWith('1970-01-01') && classId.split('|')[1] === subject) {
                            delete attendanceData[classId];
                        }
                    });

                    // Inject new dummy records using a unique, identifiable date/time
                    const newPresent = edited.present;
                    const newAbsent = edited.conducted - newPresent;
                    
                    let totalInjected = 0;
                    for (let i = 0; i < newPresent; i++) {
                        const dummyId = `1970-01-01|${subject}|P-${i}`;
                        attendanceData[dummyId] = 'present';
                        totalInjected++;
                    }
                    for (let i = 0; i < newAbsent; i++) {
                        const dummyId = `1970-01-01|${subject}|A-${i}`;
                        attendanceData[dummyId] = 'absent';
                        totalInjected++;
                    }
                    recordsAdded += totalInjected;
                }
            }
        });
        
        subjectStatsEdits = {}; // Clear subject edits
        localStorage.setItem(`smartAttendData_${userData.name}`, JSON.stringify(attendanceData));
        
        updateAllAnalytics();
        showToast('Attendance records updated!', recordsAdded > 0 ? 'bg-orange-500' : 'bg-green-500');
        showReportModal(); // Re-render report to show new calculated stats
    }
    
    // FIX: Refactored for robust PDF generation, renamed Download Sheet (Point 2, 3)
    function downloadReport() {
        playSound('save');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
        const subjectStats = getSubjectStats();
        const overallStats = calculateOverallStats();
        
        doc.setFontSize(18);
        doc.text("SmartAttend Pro - Attendance Sheet", 14, 22);
        doc.setFontSize(11);
        doc.text(`User: ${userData.name}`, 14, 32);
        doc.text(`College: ${userData.college || 'N/A'}`, 14, 38);
        doc.text(`Branch: ${userData.branch || 'N/A'}`, 14, 44);
        doc.text(`Date Generated: ${new Date().toLocaleDateString()}`, 14, 50);

        // --- Subject-wise Summary Table ---
        const subjectSummaryColumn = ["Subject", "Attended", "Conducted", "Percentage (%)"];
        const subjectSummaryRows = [];
        for (const subject in subjectStats) {
            const stats = subjectStats[subject];
            const conducted = stats.present + stats.absent;
            if (conducted > 0) {
                const percentage = ((stats.present / conducted) * 100).toFixed(1);
                subjectSummaryRows.push([stats.title, stats.present, conducted, percentage]);
            }
        }
        
        doc.setFontSize(14);
        doc.text("Subject-wise Summary", 14, 65);

        doc.autoTable({ 
            startY: 70, 
            head: [subjectSummaryColumn], 
            body: subjectSummaryRows,
            theme: 'grid',
            styles: { fontSize: 9 },
            headStyles: { fillColor: [79, 70, 229] }
        });

        // --- Overall Summary ---
        let finalY = doc.lastAutoTable.finalY;
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text("Overall Attendance Summary:", 14, finalY + 10);
        
        const overallData = [
            ["Total Attended", overallStats.present],
            ["Total Conducted", overallStats.present + overallStats.absent],
            ["Overall Percentage", `${overallStats.percentage.toFixed(1)}%`]
        ];
        
        doc.autoTable({ 
            body: overallData, 
            startY: finalY + 15,
            theme: 'plain',
            styles: { fontSize: 10, cellPadding: 1 },
        });
        
        // --- Detailed Daily Attendance Table ---
        finalY = doc.lastAutoTable.finalY;
        doc.addPage();
        finalY = 20;

        doc.setFontSize(14);
        doc.text("Detailed Daily Attendance Sheet", 14, finalY);

        const allRecords = Object.keys(attendanceData).map(classId => {
            const [date, subject, time] = classId.split('|');
            return { date, subject, time, status: attendanceData[classId], classId };
        }).sort((a, b) => new Date(a.date) - new Date(b.date));

        const detailedColumns = ["Date", "Class", "Time", "Status"];
        const detailedRows = allRecords.map(r => [
            r.date, 
            r.subject, 
            r.time, 
            r.status.charAt(0).toUpperCase() + r.status.slice(1)
        ]);
        
        doc.autoTable({ 
            startY: finalY + 5, 
            head: [detailedColumns], 
            body: detailedRows,
            theme: 'striped',
            styles: { fontSize: 8 },
            headStyles: { fillColor: [79, 70, 229] }
        });
        
        // Add footer watermark
        doc.setFontSize(8);
        doc.text("Designed and Developed by Waheed Mujtaba", 10, doc.internal.pageSize.height - 10);


        const pdfBlob = doc.output('blob');
        const url = URL.createObjectURL(pdfBlob);
        const fileName = `SmartAttend_Sheet_${userData.name}.pdf`;
       
        prepareDownload("Download Sheet", "Your PDF attendance sheet is ready.", url, fileName);
    }

    function showScheduleModal() {
        toggleMenu();
        const scheduleContent = document.getElementById('schedule-content');
        
        let tableHTML = `<table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-indigo-500 text-white">
                    <th class="py-2 px-4 border-b rounded-tl-lg">Day</th>
                    <th class="py-2 px-4 border-b rounded-tr-lg">Classes</th>
                </tr>
            </thead>
            <tbody>`;

        ALL_DAYS.forEach(day => {
            const classes = customSchedule[day] || [];
            let classList = classes.map(c => 
                `<span class="font-medium text-text-bold">${c.time}</span>: ${c.subject}`
            ).join('<br>');
            
            if (classes.length === 0) {
                classList = `<span class="text-secondary italic">No scheduled classes</span>`;
            }

            tableHTML += `
                <tr class="hover:bg-gray-50 dark:hover:bg-slate-800">
                    <td class="py-2 px-4 border-b font-bold text-lg text-indigo-600">${day}</td>
                    <td class="py-2 px-4 border-b text-sm">${classList}</td>
                </tr>`;
        });

        tableHTML += '</tbody></table>';
        scheduleContent.innerHTML = tableHTML;
        openModal('schedule-modal');
    }
    
    function showAnalysisModal() { 
        toggleMenu(); 
        openModal('analysis-modal'); 
        renderTrendChart(document.getElementById('trend-sort').value);
    }

    function renderTrendChart(period) {
        const aggregatedData = {};
        Object.keys(attendanceData).forEach(classId => {
            const date = classId.split('|')[0];
            if(holidays.includes(date)) return;
            // Ignore injected dummy records for trend analysis (1970-01-01)
            if (date.startsWith('1970-01-01')) return; 

            const status = attendanceData[classId];
            if (status === 'present' || status === 'absent') {
                const d = new Date(date);
                let key;
                if (period === 'day') key = date;
                else if (period === 'week') key = `${d.getFullYear()}-W${getWeekNumber(d)}`;
                else key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                
                if (!aggregatedData[key]) aggregatedData[key] = { present: 0, absent: 0 };
                aggregatedData[key][status]++;
            }
        });
        const sortedKeys = Object.keys(aggregatedData).sort();
        const labels = sortedKeys;
        const data = sortedKeys.map(key => (aggregatedData[key].present / (aggregatedData[key].present + aggregatedData[key].absent)) * 100);
       
        const ctx = document.getElementById('trendChart');
        if (!ctx) return; 

        if (trendChart) trendChart.destroy();

        const secondaryColor = getComputedStyle(document.body).getPropertyValue('--text-secondary');
        
        trendChart = new Chart(ctx.getContext('2d'), {
            type: 'line', 
            data: { 
                labels, 
                datasets: [{ 
                    label: 'Attendance %', 
                    data, 
                    borderColor: '#4f46e5', 
                    backgroundColor: 'rgba(79, 70, 229, 0.2)',
                    tension: 0.1, 
                    fill: true 
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        max: 100, 
                        ticks: { color: secondaryColor },
                        grid: { color: 'rgba(148, 163, 184, 0.2)' } 
                    }, 
                    x: { 
                        ticks: { color: secondaryColor },
                        grid: { color: 'rgba(148, 163, 184, 0.2)' } 
                    } 
                }, 
                plugins: { 
                    legend: { labels: { color: secondaryColor } } 
                } 
            }
        });
    }

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    
    function initializeApp(username) {
        const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
        document.getElementById('username-display').innerHTML = `Welcome, ${userData.name}`;
       
        const profilePic = localStorage.getItem(`smartAttendProfilePic_${username}`);
        if (profilePic) {
            document.getElementById('header-profile-picture').src = profilePic;
        }
        
        initChart();

        const datePicker = document.getElementById('date-picker');
        datePicker.value = selectedDate.toISOString().split('T')[0];
        datePicker.onchange = (e) => {
             // Auto-save unsaved changes before switching day
            if (Object.keys(tempAttendanceData).length > 0) {
                saveData(); 
            }
            const pickedDate = new Date(e.target.value);
            const timezoneOffset = pickedDate.getTimezoneOffset() * 60000;
            selectedDate = new Date(pickedDate.getTime() + timezoneOffset);
            tempAttendanceData = {}; // Clear for new day
            renderDailySchedule();
        };
       
        document.getElementById('trend-sort').onchange = (e) => {
            renderTrendChart(e.target.value);
        };

        document.getElementById('download-sheet-btn').textContent = 'Download Sheet';

        renderDailySchedule();
        updateAllAnalytics();
       
        const remindersEnabled = localStorage.getItem('smartAttendReminders') === 'true';
        document.getElementById('settings-reminder-toggle').checked = remindersEnabled;
        if (remindersEnabled) {
            scheduleRemindersForToday();
        }
    }


    // --- Placeholder/Remaining Functions ---
    
    function initChart() {
        if(attendanceChart) { attendanceChart.destroy(); }
        const secondaryColor = getComputedStyle(document.body).getPropertyValue('--text-secondary');

        attendanceChart = new Chart(document.getElementById('attendanceChart').getContext('2d'), {
            type: 'doughnut',
            data: { 
                labels: ['Present', 'Absent', 'Cancelled'], 
                datasets: [{ 
                    data: [0, 0, 0], 
                    backgroundColor: ['#22c55e', '#ef4444', '#94a3b8'], 
                    borderColor: getComputedStyle(document.body).getPropertyValue('--bg-card'), 
                    borderWidth: 4 
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                cutout: '70%', 
                plugins: { 
                    legend: { position: 'bottom', labels: { color: secondaryColor } } 
                } 
            }
        });
    }

    function scheduleRemindersForToday() {
        reminderTimeouts.forEach(clearTimeout);
        reminderTimeouts = [];
        const remindersEnabled = localStorage.getItem('smartAttendReminders') === 'true';
        if (!remindersEnabled || !customSchedule) return;

        const today = new Date();
        const dateString = today.toISOString().split('T')[0];
        if(holidays.includes(dateString)) return;

        const dayName = dayNames[today.getDay()];
        const daySchedule = customSchedule[dayName] || [];
        const currentExtraClasses = extraClasses[dateString] || [];
        const allPeriods = [...daySchedule, ...currentExtraClasses];

        allPeriods.forEach(period => {
            const startTimeStr = period.time.split('-')[0];
            const [hours, minutes] = startTimeStr.split(':').map(n => parseInt(n));
           
            const classTime = new Date();
            classTime.setHours(hours, minutes, 0, 0);
           
            const reminderTime = new Date(classTime.getTime() - 5 * 60000);
            const delay = reminderTime.getTime() - Date.now();

            if (delay > 0) {
                const timeoutId = setTimeout(() => {
                    showToast(`<strong>${period.subject}</strong> class starts at ${startTimeStr}`, 'bg-indigo-500', 'reminder-toast', 5000);
                }, delay);
                reminderTimeouts.push(timeoutId);
            }
        });
    }
    
    function toggleDarkMode() { 
        playSound('click');
        const isChecked = document.getElementById('dark-mode-toggle').checked;
        const theme = isChecked ? 'dark' : 'light';
        document.documentElement.className = theme;
        localStorage.setItem('smartAttendTheme', theme);
        if (attendanceChart) {
            attendanceChart.destroy();
            attendanceChart = null; 
        }
        if (trendChart) {
            trendChart.destroy();
            trendChart = null; 
        }
        updateAllAnalytics();
    }
    function confirmEraseAllData(fromSettings = false) { 
        if(fromSettings) closeModal('settings-modal');
        else toggleMenu(); 
        openModal('erase-modal'); 
    }
    function eraseAllData() {
        playSound('click');
        attendanceData = {}; tempAttendanceData = {}; extraClasses = {}; holidays = []; customSchedule = null; dailyRemovedClasses = {};
        const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
        for (let key in localStorage) {
            if (key.startsWith('smartAttend') && key.endsWith(`_${userData.name}`)) {
                localStorage.removeItem(key);
            }
        }
        localStorage.removeItem('smartAttendUser');
        closeModal('erase-modal');
        showToast('All data erased successfully! Logging out...', 'bg-red-500');
        setTimeout(() => window.location.reload(), 1500);
    }
    function showFeedbackModal() { toggleMenu(); openModal('feedback-modal'); }
    
    // FIX: Updated sendFeedback to create a mailto link using the specified email and textarea content
    function sendFeedback() { 
        playSound('click');
        const feedbackText = document.getElementById('feedback-text').value.trim();
        
        if (feedbackText.length === 0) {
            showToast('Please enter your feedback before sending.', 'bg-orange-500');
            return;
        }

        const subject = encodeURIComponent("SmartAttend Pro Feedback/Bug Report");
        const body = encodeURIComponent(
            "--- Feedback from SmartAttend Pro ---\n\n" + 
            feedbackText + 
            "\n\n--------------------------------------"
        );
        
        // Construct the mailto link
        const mailtoLink = `mailto:${FEEDBACK_EMAIL}?subject=${subject}&body=${body}`;
        
        // Open the email client
        window.open(mailtoLink);
        
        // Clear and close modal immediately after opening the link
        document.getElementById('feedback-text').value = '';
        closeModal('feedback-modal');
        showToast('Opening email client for feedback.', 'bg-green-500');
    }
    
    function showAboutModal() { toggleMenu(); openModal('about-modal'); }
    function toggleReminders(event) { 
        playSound('click');
        const isChecked = event.target.checked;
        document.getElementById('settings-reminder-toggle').checked = isChecked;
        localStorage.setItem('smartAttendReminders', isChecked);
        if (isChecked) {
            scheduleRemindersForToday();
            showToast('Reminders are ON', 'bg-blue-500');
        } else {
            reminderTimeouts.forEach(clearTimeout);
            reminderTimeouts = [];
            showToast('Reminders are OFF', 'bg-gray-500');
        }
    }
    
    // FIX: Fixed exportData (Point 2)
    function exportData() { 
        playSound('save');
        const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
        
        // Exclude profile pic from main data object to keep it cleaner
        const dataToExport = {
            attendanceData: attendanceData,
            extraClasses: extraClasses,
            holidays: holidays,
            dailyRemovedClasses: dailyRemovedClasses,
            customSchedule: customSchedule,
            profile: {
                name: userData.name,
                password: userData.password,
                college: userData.college,
                branch: userData.branch
            }
        };

        const dataStr = JSON.stringify(dataToExport, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"}); // Change to application/json for better compatibility
        const url = URL.createObjectURL(dataBlob);
        const fileName = `smartattend_backup_${userData.name}.json`;
       
        prepareDownload("Export Data", "Your backup file is ready.", url, fileName);
    }

    function showImportExportModal() { toggleMenu(); openModal('import-export-modal'); }
    function prepareDownload(title, message, url, fileName) { 
        if (currentDownloadUrl) {
            URL.revokeObjectURL(currentDownloadUrl);
        }
        currentDownloadUrl = url;

        document.getElementById('download-title').textContent = title;
        document.getElementById('download-message').textContent = message;
        const link = document.getElementById('download-link');
        link.href = url;
        link.download = fileName;
       
        openModal('download-modal');
    }
    function closeDownloadModal() { 
        if (currentDownloadUrl) {
            URL.revokeObjectURL(currentDownloadUrl);
            currentDownloadUrl = null;
        }
        closeModal('download-modal');
    }
    function importData(event) { 
        playSound('save');
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.attendanceData && importedData.customSchedule && importedData.holidays && importedData.profile) {
                    
                    const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
                    const username = userData.name; // Use current user name for keys

                    attendanceData = importedData.attendanceData;
                    extraClasses = importedData.extraClasses || {};
                    holidays = importedData.holidays;
                    dailyRemovedClasses = importedData.dailyRemovedClasses || {};
                    customSchedule = importedData.customSchedule;
                    
                    // Update user profile details from imported data
                    let importedUser = JSON.parse(localStorage.getItem('smartAttendUser')) || {};
                    importedUser.name = importedData.profile.name || importedUser.name;
                    importedUser.password = importedData.profile.password || importedUser.password;
                    importedUser.college = importedData.profile.college || importedUser.college;
                    importedUser.branch = importedData.profile.branch || importedUser.branch;
                    
                    localStorage.setItem('smartAttendUser', JSON.stringify(importedUser));

                    localStorage.setItem(`smartAttendData_${username}`, JSON.stringify(attendanceData));
                    localStorage.setItem(`smartAttendExtraClasses_${username}`, JSON.stringify(extraClasses));
                    localStorage.setItem(`smartAttendHolidays_${username}`, JSON.stringify(holidays));
                    localStorage.setItem(`smartAttendRemovedClasses_${username}`, JSON.stringify(dailyRemovedClasses));
                    localStorage.setItem(`smartAttendSchedule_${username}`, JSON.stringify(customSchedule));
                    // Note: Profile pic migration logic is complex and skipped here, rely on user to re-upload if needed.

                    showToast('Data imported successfully! Reloading...', 'bg-green-500');
                    setTimeout(() => window.location.reload(), 1500);

                } else {
                    showToast('Invalid data file. Missing key data structures (attendanceData, customSchedule, holidays, profile).', 'bg-red-500', 'toast-notification', 6000);
                }
            } catch (error) {
                showToast('Error reading or parsing file. Ensure it is a valid JSON backup.', 'bg-red-500', 'toast-notification', 6000);
                console.error("Import error:", error);
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }
    function showVersionModal(fromSettings = false) { if(!fromSettings) toggleMenu(); openModal('version-modal'); }
    function showSettingsModal() { 
        toggleMenu(); 
        const remindersEnabled = localStorage.getItem('smartAttendReminders') === 'true';
        document.getElementById('settings-reminder-toggle').checked = remindersEnabled;
        openModal('settings-modal'); 
    }

    // --- DOM INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        window.addEventListener('click', () => {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }, { once: true });

        document.getElementById('login-button').addEventListener('click', handleLogin);
        document.getElementById('profile-pic-upload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64Image = e.target.result;
                const userData = JSON.parse(localStorage.getItem('smartAttendUser'));
                localStorage.setItem(`smartAttendProfilePic_${userData.name}`, base64Image);
                document.getElementById('profile-picture').src = base64Image;
                document.getElementById('header-profile-picture').src = base64Image;
            };
            reader.readAsDataURL(file);
        });
        document.getElementById('import-file-input').addEventListener('change', importData);

        // Initial check now handles the loading screen
        checkAuth();
    });
  </script>
</body>
</html>
